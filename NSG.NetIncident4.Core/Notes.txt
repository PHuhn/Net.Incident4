https://www.c-sharpcorner.com/article/authentication-and-authorization-in-asp-net-5-with-jwt-and-swagger/
ASP.NET Core Web API (project template)
Clean Architecture:
	https://github.com/jasontaylordev/NorthwindTraders
CQRS stands for command query responsibility segregation

For external login of the Web-API:...
In the secrets.json store:
	in "Authentication:Google", the generated Google's "ClientId" and "ClientSecret".
	in "Authentication:Microsoft", the generated Microsoft Account's "ClientId" and "ClientSecret".
See project file: <UserSecretsId>aspnet-NSG.NetIncident4.Core-7565303C-46F5-41FE-B2C2-5A0FF48FFEB3</UserSecretsId>
located: C:\Users\Phil\AppData\Roaming\Microsoft\UserSecrets\aspnet-NSG.NetIncident4.Core-7565303C-46F5-41FE-B2C2-5A0FF48FFEB3
Note: this does not allow login to the Angular app.

Packages:
	Install-Package Microsoft.EntityFrameworkCore.SqlServer -version 5.0.12
	Install-Package Microsoft.EntityFrameworkCore.Tools -version 5.0.12
	Install-Package Microsoft.AspNetCore.Identity.EntityFrameworkCore -version 5.0.12
	Install-Package Microsoft.AspNetCore.Identity -version 2.2.0
	Install-Package Microsoft.AspNetCore.Authentication.JwtBearer -version 5.0.12
	- Swashbuckle.AspNetCore (5.6.3) came with the project -
	Install-Package MediatR
	Install-Package MediatR.Extensions.Microsoft.DependencyInjection -Version 9.0.0
	9.0.0
	Install-Package FluentValidation.AspNetCore
	10.3.4
	Install-Package OdeToCode.AddFeatureFolders
	Install-Package MimeKit
	2.15.1
	Install-Package Microsoft.AspNetCore.Identity.UI -version 5.0.12
	Install-Package bootstrap
	Install-Package Microsoft.Identity.Web.UI
	(1.21.0)
	Install-Package Microsoft.EntityFrameworkCore.Relational -version 5.0.12

	Install-package Microsoft.AspNetCore.Authentication.Google -version 6.0.8
	Install-package Microsoft.AspNetCore.Authentication.MicrosoftAccount -version 6.0.8

	Install-Package System.ServiceModel.Syndication -Version 6.0.0
	Install-Package Microsoft.SyndicationFeed.ReaderWriter -Version 1.0.2

	install-package jquery
	bootstrap

	Click on the project and select add, then add a scaffolding item and select Identity
		Override all, select DB Context.

Create db:
	https://weblog.west-wind.com/posts/2016/jan/13/resetting-entity-framework-migrations-to-a-clean-slate
	Issue with MS's implementation of SQLite in an update of migration...
	*	Remove the _MigrationHistory table from the Database
	*	Remove the individual migration files in your project's Migrations folder
	*	Add-migration Initial in PMC
	*	Comment out the code inside of the Up method in the Initial Migration
	*	Update-database in PMC (does nothing but creates Migration Entry)
	*	Remove comments in the Initial method

	add-migration Initial
	update-database
	Add-Migration "Update-2021-11-27-11-30"
	Update-Database

	Add-Migration "Update-2023-02-24-11-52"
	Update-Database

	on 2023-02-25 ...
	Add-Migration Initial -verbose
	Update-Database -verbose
	Remove-Migration -verbose

==============================================================================
==============================================================================
PROBLEM:
	Unable to resolve service for type 'Microsoft.AspNetCore.Session.ISessionStore' while attempting to activate 'Microsoft.AspNetCore.Session.SessionMiddleware'.
SOLUTION:
    services.AddSession(options => {
        options.Cookie.IsEssential = true;
    });

PROBLEM:
	InvalidOperationException: Unable to resolve service for type 'NSG.NetIncident4.Core.Infrastructure.Notification.INotificationService' while attempting to activate 'NSG.NetIncident4.Core.UI.Controllers.HomeController'.
	Microsoft.Extensions.DependencyInjection.ActivatorUtilities.GetService(IServiceProvider sp, Type type, Type requiredBy, bool isDefaultParameterRequired)
SOLUTION:
    services.AddSingleton<INotificationService, NotificationService>();
    services.AddSingleton<IEmailSender, NotificationService>();

PROBLEM:
	Access to XMLHttpRequest at 'https://localhost:44362/api/Authenticate/Login' from
	origin 'http://localhost:4200' has been blocked by CORS policy: No 'Access-Control-Allow-Origin' header is present on the requested resource.
SOLUTION:
		services.AddCors(options => {
			options.AddPolicy("CorsAnyOrigin", builder => {
				builder
					.WithOrigins("http://localhost:4200,http://localhost:10111")
					.AllowAnyOrigin()
					.AllowAnyHeader()
					.AllowAnyMethod();
			});
		});

		app.UseCors("CorsAnyOrigin");

PROBLEM:
	In Angular:
	HttpErrorResponse {headers: HttpHeaders, status: 415, statusText: 'OK', url: 'https://localhost:44362/api/Authenticate/Login', ok: false, …}
		error: status: 415, title: "Unsupported Media Type"
SOLUTION:
	Changed from:
	const options = { headers: new HttpHeaders().set( 'Content-Type', 'application/x-www-form-urlencoded' ) };
	to:
	const options = { headers: new HttpHeaders().set( 'Content-Type', 'application/json' ) };
 
PROBLEM:
	Tryig to display signon form:
	No webpage was found for the web address: Account/SignIn?area= "MicrosoftIdentity"
SOLUTION:
    services.AddControllersWithViews(options =>
    {
        var policy = new AuthorizationPolicyBuilder()
            .RequireAuthenticatedUser()
            .Build();
    }).AddMicrosoftIdentityUI();

PROBLEM:
	Connection failed in IIS
SOLUTION:
	In IIS Management console: click on Authentication icon,
	then disable all except Anonymous Authentication,
	then r-click Anonymous Authentication and select Edit,
	in Edit form select radio button of 'Application pool identity'.
	Set the the permissions in the Application pool on the 'Advanced Settings',
	set the Identity options to LocalSystem or your preference.

	In Sql Server SSMS: in query window select the DB and execute the following,
	USE [master]
	GO
	IF NOT EXISTS(SELECT name FROM [master].[sys].[syslogins] WHERE NAME = 'NT AUTHORITY\SYSTEM')
	BEGIN 
		PRINT 'Create'
		CREATE LOGIN [NT AUTHORITY\SYSTEM] FROM WINDOWS WITH DEFAULT_DATABASE=[master], DEFAULT_LANGUAGE=[us_english]
	END
	GO
	IF NOT EXISTS(SELECT name FROM [master].[sys].[syslogins] WHERE NAME = 'NT AUTHORITY\LOCAL SERVICE')
	BEGIN 
		PRINT 'Create NT AUTHORITY\LOCAL SERVICE'
		CREATE LOGIN [NT AUTHORITY\LOCAL SERVICE] FROM WINDOWS WITH DEFAULT_DATABASE=[master], DEFAULT_LANGUAGE=[us_english]
	END
	GO
	IF NOT EXISTS(SELECT name FROM [master].[sys].[syslogins] WHERE NAME = 'NT AUTHORITY\NETWORK SERVICE')
	BEGIN 
		PRINT 'Create NT AUTHORITY\NETWORK SERVICE'
		CREATE LOGIN [NT AUTHORITY\NETWORK SERVICE] FROM WINDOWS WITH DEFAULT_DATABASE=[master], DEFAULT_LANGUAGE=[us_english]
	END
	GO

	USE [NetIncidentIdentity04]
	GO
	CREATE USER [NT AUTHORITY\SYSTEM] FOR LOGIN [NT AUTHORITY\SYSTEM] WITH DEFAULT_SCHEMA=[dbo]
	GO
	CREATE USER [NT AUTHORITY\NETWORK SERVICE] FOR LOGIN [NT AUTHORITY\NETWORK SERVICE] WITH DEFAULT_SCHEMA=[dbo]
	GO
	CREATE USER [NT AUTHORITY\LOCAL SERVICE] FOR LOGIN [NT AUTHORITY\LOCAL SERVICE] WITH DEFAULT_SCHEMA=[dbo]
	GO
	ALTER ROLE [db_datareader] ADD MEMBER [NT AUTHORITY\SYSTEM]
	GO
	ALTER ROLE [db_datawriter] ADD MEMBER [NT AUTHORITY\SYSTEM]
	GO
	ALTER ROLE [db_datareader] ADD MEMBER [NT AUTHORITY\NETWORK SERVICE]
	GO
	ALTER ROLE [db_datawriter] ADD MEMBER [NT AUTHORITY\NETWORK SERVICE]
	GO
	ALTER ROLE [db_datareader] ADD MEMBER [NT AUTHORITY\LOCAL SERVICE]
	GO
	ALTER ROLE [db_datawriter] ADD MEMBER [NT AUTHORITY\LOCAL SERVICE]
	GO

PROBLEM:
	Only in the published site, from the Angular application (after the login):
		Access to XMLHttpRequest at 'https://localhost:9114/api/Incidents/' from origin 
		'http://localhost:4200' has been blocked by CORS policy: No
		'Access-Control-Allow-Origin' header is present on the requested resource.
SOLUTION:
	https://docs.microsoft.com/en-us/aspnet/core/fundamentals/middleware/?view=aspnetcore-6.0#middleware-order
	In the Startup.cs 'public virtual void Configure' method, use order:
		ExceptionHandler / Hsts / HttpsRedirection / StaticFiles / CookiePolicy /
		Routing / RequestLocalization / Cors / Authentication / Authorization /
		Session / ResponseCompression / ResponseCaching / ...custom... / Endpoint

PROBLEM (2022-07-10):
	InvalidOperationException: The relationship from 'IncidentNote.NoteType' to 
	'NoteType.IncidentNotes' with foreign key properties {'IncidentNoteId' : long} cannot
	target the primary key {'NoteTypeId' : int} because it is not compatible. Configure a
	principal key or a set of foreign key properties with compatible types for this relationship.
SOLUTION:
	incorrect OnModelCreating configuration in NoteTypeConfiguration:
			builder.HasMany(nt => nt.IncidentNotes)
				.WithOne(n => n.NoteType)
				.HasForeignKey(nt => nt.IncidentNoteId)
				.OnDelete(DeleteBehavior.Restrict)
				.HasConstraintName("FK_IncidentNote_NoteType_NoteTypeId");
	to:
			builder.HasMany(nt => nt.IncidentNotes)
				.WithOne(n => n.NoteType)
				.HasForeignKey(nt => nt.NoteTypeId)
				.OnDelete(DeleteBehavior.Restrict)
				.HasConstraintName("FK_IncidentNote_NoteType_NoteTypeId");

PROBLEM:
	Your connection is not private
	Attackers might be trying to steal your information from localhost (for example, passwords, messages, or credit cards). Learn more
	NET::ERR_CERT_DATE_INVALID

SOLUTION:
	MMC => Add Certificate => click root => Action => Find .. LocalHost
	RClick => delete the out-of-date cert
	Now I get NET::ERR_CERT_AUTHORITY_INVALID
		Open IIS Manager as Admin
		Select Local Machine (Colony7) from the Connection tree
		Select "Server Certificate" from the IIS section
		Select "Create Self-Signed Certificate" (on right)
		Assign a Freindly Name to the certificate
		Click OK
		Restart IIS
		Now I get ERR_CONNECTION_RESET
			> cd "C:\Program Files (x86)\IIS Express"
			> IisExpressAdminCmd.exe setupsslUrl -url:https://localhost:9114/ -UseSelfSigned
			Now I get NET::ERR_CERT_AUTHORITY_INVALID (in IIS Manager it said,
			the certificate was not trusted,
			is said to install it into Trusted Root Certificates)

PROBLEM:
 	 ApplicationDbContext_DuplicateCreateCompany_Test
   	   Source: ApplicationDbContext_UnitTests.cs line 122
		Microsoft.Data.Sqlite.SqliteException : SQLite Error 1: 'AUTOINCREMENT is only allowed on an INTEGER PRIMARY KEY'.
	fail: Microsoft.EntityFrameworkCore.Database.Command[20102]
		  Failed executing DbCommand (2ms) [Parameters=[], CommandType='Text', CommandTimeout='30']
		  CREATE TABLE "IncidentNote" (
			  "IncidentNoteId" bigint NOT NULL CONSTRAINT "PK_IncidentNote" PRIMARY KEY AUTOINCREMENT,
			  ...
		  );

SOLUTION:
	Change the entity as follows:
		[Key, DatabaseGenerated(DatabaseGeneratedOption.Identity)]
		[Required(ErrorMessage = "IncidentNoteId is required.")]
		public long IncidentNoteId { get; set; }

		info: Microsoft.EntityFrameworkCore.Database.Command[20101]
			Executed DbCommand (0ms) [Parameters=[], CommandType='Text', CommandTimeout='30']
		CREATE TABLE "IncidentNote" (
			"IncidentNoteId" INTEGER NOT NULL CONSTRAINT "PK_IncidentNote" PRIMARY KEY AUTOINCREMENT,
			"NoteTypeId" int NOT NULL,
			"Note" TEXT NOT NULL,
			"CreatedDate" datetime2 NOT NULL,
			CONSTRAINT "FK_IncidentNote_NoteType_NoteTypeId" FOREIGN KEY ("NoteTypeId") REFERENCES "NoteType" ("NoteTypeId") ON DELETE RESTRICT
		);

	Change the EntityTypeBuilder to not use
		item.HasKey(i => i.IncidentNoteId);
		//item.Property(i => i.IncidentNoteId)
		//    .IsRequired()
		//    .HasColumnName("IncidentNoteId")
		//    .HasColumnType("bigint");


PROBLEM:
	Date:	2023-03-02
	Failed executing DbCommand (0ms) [Parameters=[], CommandType='Text', CommandTimeout='30']
	CREATE TABLE [AspNetRoleClaims] (
		[Id] int NOT NULL IDENTITY,
		[RoleId] nvarchar(450) NOT NULL,
		[ClaimType] nvarchar(1073741823) NULL,
		[ClaimValue] nvarchar(1073741823) NULL,
		CONSTRAINT [PK_AspNetRoleClaims] PRIMARY KEY ([Id])
	);
	Error Number:131,State:2,Class:15
	The size (1073741823) given to the column 'ClaimType' exceeds the maximum allowed for any data type (8000).

SOLUTION:
	Date:	2023-03-02
	Changed from:
		public void Configure(EntityTypeBuilder<IdentityRoleClaim<string>> builder)
		{
			builder.ToTable("AspNetRoleClaims");
			// propteries
			builder.HasKey(a => a.Id);
			builder.Property(a => a.RoleId)
				.IsRequired()
				.HasMaxLength(450)
				.HasColumnName("RoleId")
				.HasColumnType("nvarchar");
			builder.Property(a => a.ClaimType)
				.HasMaxLength(1073741823)
				.HasColumnName("ClaimType")
				.HasColumnType("nvarchar");
			builder.Property(a => a.ClaimValue)
				.HasMaxLength(1073741823)
				.HasColumnName("ClaimValue")
				.HasColumnType("nvarchar");
			// indexes
			builder.HasIndex(a => a.RoleId)
				.HasDatabaseName("IX_AspNetRoleClaims_RoleId");
			// relationships
		} // Configure
	Changed to:
		public void Configure(EntityTypeBuilder<IdentityRoleClaim<string>> builder)
		{
			builder.ToTable("AspNetRoleClaims");
			// propteries
			builder.HasKey(a => a.Id);
			builder.Property(a => a.RoleId)
				.IsRequired()
				.HasMaxLength(450)
				.HasColumnName("RoleId")
				.HasColumnType("nvarchar");
			// indexes
			builder.HasIndex(a => a.RoleId)
				.HasDatabaseName("IX_AspNetRoleClaims_RoleId");
			// relationships
		} // Configure


PROBLEM:
	Upgrade to .Net 7	(2023-10-28)

SOLUTION:
	Updated Visual Studio in Visual Studio Installer
	In the project ...
        <TargetFramework>net7.0</TargetFramework>
	...
	<ItemGroup Condition="'$(TargetFramework)' == 'net7.0'">
		<PackageReference Include="Microsoft.AspNetCore.Authentication.JwtBearer" Version="7.0.13" />
		<PackageReference Include="Microsoft.AspNetCore.Authentication.OpenIdConnect" Version="7.0.13" />
		<PackageReference Include="Microsoft.AspNetCore.Identity.EntityFrameworkCore" Version="7.0.13" />
		<PackageReference Include="Microsoft.AspNetCore.Identity.UI" Version="7.0.13" />
		<PackageReference Include="Microsoft.EntityFrameworkCore.Relational" Version="7.0.13" />
		<PackageReference Include="Microsoft.EntityFrameworkCore.SqlServer" Version="7.0.13" />
		<PackageReference Include="Microsoft.EntityFrameworkCore.Tools" Version="7.0.13">
			<PrivateAssets>all</PrivateAssets>
			<IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
		</PackageReference>
		<PackageReference Include="Microsoft.VisualStudio.Web.CodeGeneration.Design" Version="7.0.11" />
		<PackageReference Include="Microsoft.AspNetCore.TestHost" Version="7.0.13" />
		<PackageReference Include="Microsoft.AspNetCore.Authentication.Google" Version="7.0.13" />
		<PackageReference Include="Microsoft.AspNetCore.Authentication.MicrosoftAccount" Version="7.0.13" />
	</ItemGroup>

	Install-package Microsoft.AspNetCore.Authentication.JwtBearer -version 7.0.13
	Install-package Microsoft.AspNetCore.Authentication.OpenIdConnect -version 7.0.13
	Install-package Microsoft.AspNetCore.Identity.EntityFrameworkCore -version 7.0.13
	Install-package Microsoft.AspNetCore.Identity.UI -version 7.0.13
	Install-package Microsoft.EntityFrameworkCore.Relational -version 7.0.13
	Install-package Microsoft.EntityFrameworkCore.SqlServer -version 7.0.13
	Install-package Microsoft.EntityFrameworkCore.Tools -version 7.0.13
	Install-package Microsoft.VisualStudio.Web.CodeGeneration.Design -version 7.0.11
	Install-package Microsoft.AspNetCore.TestHost -version 7.0.13
	Install-package Microsoft.AspNetCore.Authentication.Google -version 7.0.13
	Install-package Microsoft.AspNetCore.Authentication.MicrosoftAccount -version 7.0.13
	In test:
	Install-package Microsoft.EntityFrameworkCore.InMemory -version 7.0.13
	Install-package Microsoft.EntityFrameworkCore.SqLite -version 7.0.13
	Install-package Microsoft.Extensions.Logging -version 7.0.0

========
PROBLEM:
	Win32Exception: The certificate chain was issued by an authority that is not trusted.
	Unknown location
	SqlException: A connection was successfully established with the server, but then an error occurred during the login process. (provider: SSL Provider, error: 0 - The certificate chain was issued by an authority that is not trusted.)
	Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, bool breakConnection, Action<Action> wrapCloseInAction)

SOLUTION:
	Add Encrypt=False to the connectionString

========
PROBLEM:


SOLUTION:


